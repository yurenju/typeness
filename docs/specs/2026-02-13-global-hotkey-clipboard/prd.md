# Typeness Phase 2：全域快捷鍵與剪貼簿自動貼上

## 1. 簡介

Typeness MVP 已驗證了語音辨識（Whisper）和文字後處理（LLM）的核心能力，但目前只能在終端機中透過 Enter 鍵操作，使用場景侷限在終端機內。

本階段的目標是讓 Typeness 成為一個**真正可用的語音輸入工具**——使用者在任何應用程式（瀏覽器、編輯器、聊天軟體等）中，只要按下右 Alt 鍵就能開始語音輸入，辨識完成後自動將整理好的文字貼上到當前游標位置。

基於 `docs/specs/2026-02-13-mvp-voice-input/prd.md` 的 MVP 成果。

---

## 2. 目標

- **實現全域快捷鍵觸發**：在任何應用程式中都能透過右 Alt 鍵啟動/停止語音辨識，不受限於終端機
- **實現自動貼上**：辨識結果自動複製到剪貼簿並貼上到當前焦點位置，讓語音輸入的使用體驗無縫銜接
- **維持低延遲**：加入剪貼簿與自動貼上後，端到端延遲仍維持在可接受範圍（目標 < 3 秒）
- **保持穩定性**：全域鍵盤 hook 不影響其他應用程式的正常運作

---

## 3. 使用者故事

### 故事 1：在瀏覽器中語音輸入

> 作為使用者，我在瀏覽器的搜尋框中點擊游標，按下右 Alt 開始說話，說完後再按一次右 Alt，幾秒後整理好的文字就自動出現在搜尋框中。我不需要手動切換視窗或複製貼上。

### 故事 2：在聊天軟體中語音輸入

> 作為使用者，我在 LINE、Discord 或 Teams 的聊天輸入框中，按右 Alt 說一段話，再按右 Alt 結束，處理後的文字就自動填入聊天框，我只要按 Enter 送出就好。

### 故事 3：在程式碼編輯器中語音輸入

> 作為使用者，我在 VS Code 或其他編輯器中撰寫註解或文件時，按右 Alt 口述內容，結束後整理好的文字自動貼到游標位置。

### 故事 4：連續多次語音輸入

> 作為使用者，我可以在同一個應用程式中連續多次按右 Alt 進行語音輸入。每次輸入完成後，文字自動貼上，我可以立即開始下一次輸入。

---

## 4. 功能需求

### 4.1 全域快捷鍵監聽

- **FR-1**：程式在終端機前景運行，同時啟用全域鍵盤 hook，監聽右 Alt 鍵事件
- **FR-2**：右 Alt 鍵採用 Toggle 模式——第一次按下開始錄音，第二次按下停止錄音並觸發辨識流程
- **FR-3**：全域鍵盤 hook 在任何應用程式獲得焦點時都能運作（包括瀏覽器、聊天軟體、編輯器等）
- **FR-4**：全域鍵盤 hook 不干擾其他應用程式對右 Alt 鍵的正常使用（僅攔截單獨按下右 Alt 的事件，不影響 Alt 組合鍵）
- **FR-5**：程式啟動時在終端機顯示提示訊息，告知使用者可用右 Alt 觸發語音輸入

### 4.2 剪貼簿整合與自動貼上

- **FR-6**：辨識與 LLM 處理完成後，將 LLM 處理後的最終文字複製到系統剪貼簿
- **FR-7**：複製到剪貼簿後，自動模擬 Ctrl+V 鍵盤事件，將文字貼上到當前焦點視窗的游標位置
- **FR-8**：自動貼上在常見的 Windows 應用程式中能正常運作（瀏覽器輸入框、文字編輯器、聊天軟體輸入框等）

### 4.3 運行模式

- **FR-9**：程式仍在終端機前景運行，透過 `uv run python typeness.py`（或類似指令）啟動
- **FR-10**：終端機中顯示運行狀態 log（開始錄音、停止錄音、辨識結果、處理結果等）
- **FR-11**：支援 Ctrl+C 優雅退出，退出時清除全域鍵盤 hook

### 4.4 模組化

- **FR-12**：允許將程式碼拆分為多個 Python 模組（如鍵盤監聽、剪貼簿操作、錄音、辨識等），不再限制為單一檔案

---

## 5. 非目標（超出範圍）

本階段**不包含**以下功能：

- 快捷鍵自訂（目前硬編碼為右 Alt）
- Push-to-talk 模式（按住錄音、放開停止）
- 系統匣圖示或背景服務模式
- 錄音中的視覺或聲音回饋（如系統匣圖示變色、提示音）
- 打包為獨立執行檔
- 設定檔或使用者介面
- macOS 或 Linux 支援（僅 Windows）
- 多語言支援（僅繁體中文）

---

## 6. 技術考量

- **全域鍵盤 hook**：在 Windows 上需要使用系統層級的鍵盤 hook 來監聽全域按鍵事件。需考慮管理員權限的需求
- **剪貼簿操作**：需使用 Windows 剪貼簿 API 寫入文字
- **模擬鍵盤輸入**：自動貼上需要模擬 Ctrl+V 鍵盤事件，需注意與全域鍵盤 hook 的交互作用（避免自己的模擬事件被自己攔截）
- **非同步流程**：辨識和 LLM 處理需要幾秒鐘，這段時間使用者可能已切換到其他視窗。自動貼上時需確保貼到使用者預期的位置
- **與 MVP 架構的關係**：核心的錄音、Whisper 辨識、LLM 處理邏輯不變，主要是替換「輸入觸發方式」（Enter → 右 Alt）和「輸出方式」（印在終端機 → 剪貼簿 + 貼上）

---

## 7. 高階驗收標準

- **AC-1**：程式啟動後，在終端機顯示「就緒」訊息，提示使用者可按右 Alt 開始語音輸入
- **AC-2**：在瀏覽器的文字輸入框中點擊游標，按右 Alt 開始錄音，說一段話，再按右 Alt 停止，幾秒後整理好的文字自動出現在輸入框中
- **AC-3**：在 VS Code 的編輯區域中進行同樣的操作，文字自動出現在游標位置
- **AC-4**：辨識完成後，打開記事本按 Ctrl+V，能貼上與自動貼上相同的內容（確認剪貼簿中有正確的內容）
- **AC-5**：連續進行兩次語音輸入，兩次都能正常辨識並自動貼上
- **AC-6**：在錄音過程中，其他 Alt 組合鍵（如 Alt+Tab）仍能正常運作
- **AC-7**：按 Ctrl+C 能正常結束程式，結束後右 Alt 鍵恢復正常功能

---

## 8. 開放問題

- ~~**管理員權限**~~：已確認 `WH_KEYBOARD_LL` 低階鍵盤 hook **不需要管理員權限**，一般使用者即可安裝。唯一限制是當焦點在「以管理員身份執行」的提權應用程式上時無法接收按鍵，但日常使用的瀏覽器、編輯器、聊天軟體等一般應用不受影響。建議使用 `pynput` 套件，以一般使用者執行
- **右 Alt 與 AltGr**：某些鍵盤佈局下右 Alt 會被當作 AltGr，需確認在繁體中文輸入法環境下的行為
- **焦點視窗切換**：如果使用者在等待辨識結果時切換了視窗，自動貼上應該貼到哪個視窗？（目前設計：貼到辨識完成時的前景視窗）
- **輸入法衝突**：自動模擬 Ctrl+V 時，如果使用者的輸入法正在組字中，是否會造成衝突？
- **防毒軟體攔截**：全域鍵盤 hook 和模擬鍵盤輸入可能被某些防毒軟體視為可疑行為，需要注意

---

## 9. 參考資料

- [Typeness MVP PRD](../2026-02-13-mvp-voice-input/prd.md)
- [Typeness MVP 實作計畫](../2026-02-13-mvp-voice-input/implementation.md)
- [Typeness 技術可行性研究](../../research/2026-02-12-voice-input-tool-feasibility.md)
